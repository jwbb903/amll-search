name: Build DictPen P5 Toolchain

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILDROOT_VERSION: 2018.02-rc3
  BUILDROOT_URL: https://buildroot.org/downloads/buildroot-2018.02-rc3.tar.gz
  DEFCONFIG_NAME: dictpen_p5_defconfig

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git wget cpio unzip rsync bc \
            libncurses5-dev libncursesw5-dev libssl-dev \
            flex bison libelf-dev python2 python3 file gawk \
            texinfo help2man libtool-bin autoconf automake \
            pkg-config cmake libglib2.0-dev libfdt-dev \
            libpixman-1-dev zlib1g-dev device-tree-compiler \
            locales
          sudo ln -sf /usr/bin/python2 /usr/bin/python

      - name: Set locale
        run: |
          sudo locale-gen en_US.UTF-8
          sudo update-locale LANG=en_US.UTF-8

      - name: Cache downloaded sources
        id: cache-dl
        uses: actions/cache@v4
        with:
          path: buildroot-${{ env.BUILDROOT_VERSION }}/dl
          key: ${{ runner.os }}-buildroot-dl-${{ hashFiles(format('buildroot-{0}/dl/**', env.BUILDROOT_VERSION)) }}
          restore-keys: |
            ${{ runner.os }}-buildroot-dl-

      - name: Download Buildroot
        run: |
          wget -q ${{ env.BUILDROOT_URL }}
          tar -xf buildroot-${{ env.BUILDROOT_VERSION }}.tar.gz

      - name: Copy defconfig
        run: |
          if [ -f "configs/${{ env.DEFCONFIG_NAME }}" ]; then
            cp configs/${{ env.DEFCONFIG_NAME }} buildroot-${{ env.BUILDROOT_VERSION }}/configs/
          else
            # 使用 echo 直接写入文件，避免 heredoc 的缩进问题
            echo 'BR2_aarch64=y' > buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_cortex_a55=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_ARM_FPU_VFPV4=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_TOOLCHAIN_BUILDROOT=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_TOOLCHAIN_BUILDROOT_GLIBC=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_GCC_VERSION_7_X=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_BINUTILS_VERSION_2_29_X=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_KERNEL_HEADERS_4_19=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_TOOLCHAIN_BUILDROOT_CXX=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_INSTALL_LIBSTDCPP=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_TOOLCHAIN_HAS_SSP=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_TOOLCHAIN_HAS_NATIVE_RPC=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_USE_MMU=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_TARGET_OPTIMIZATION="-pipe -O2"' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_TARGET_GENERIC_GETTY=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_TARGET_GENERIC_GETTY_PORT="ttyFIQ0"' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_TARGET_GENERIC_HOSTNAME="buildroot"' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_TARGET_GENERIC_ISSUE="Welcome to Buildroot"' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_SYSTEM_BIN_SH_BUSYBOX=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_SDK=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
            echo 'BR2_PACKAGE_HOST_GDB=y' >> buildroot-${{ env.BUILDROOT_VERSION }}/configs/${{ env.DEFCONFIG_NAME }}
          fi

      - name: Configure Buildroot
        working-directory: buildroot-${{ env.BUILDROOT_VERSION }}
        run: |
          make ${{ env.DEFCONFIG_NAME }}

      - name: Build toolchain and SDK
        working-directory: buildroot-${{ env.BUILDROOT_VERSION }}
        run: |
          make toolchain -j2
          make sdk -j2

      - name: Prepare SDK archive
        working-directory: buildroot-${{ env.BUILDROOT_VERSION }}
        run: |
          SDK_ARCHIVE=$(ls output/images/*sdk*.tar.gz | head -1)
          if [ -z "$SDK_ARCHIVE" ]; then
            echo "SDK archive not found!"
            exit 1
          fi
          cp $SDK_ARCHIVE ../dictpen-p5-sdk.tar.gz

      - name: Create environment script
        run: |
          cat > dictpen-env.sh << 'EOF'
#!/bin/bash
export PATH="$PWD/buildroot-${{ env.BUILDROOT_VERSION }}/output/host/usr/bin:$PATH"
export CROSS_COMPILE="aarch64-linux-"
export ARCH="arm64"
export SYSROOT="$PWD/buildroot-${{ env.BUILDROOT_VERSION }}/output/host/usr/aarch64-buildroot-linux-gnu/sysroot"
export CC="aarch64-linux-gcc --sysroot=\$SYSROOT"
export CXX="aarch64-linux-g++ --sysroot=\$SYSROOT"
export LD="aarch64-linux-ld --sysroot=\$SYSROOT"
export AR="aarch64-linux-ar"
export AS="aarch64-linux-as"
export NM="aarch64-linux-nm"
export STRIP="aarch64-linux-strip"
export RANLIB="aarch64-linux-ranlib"
export OBJCOPY="aarch64-linux-objcopy"
export OBJDUMP="aarch64-linux-objdump"
export GDB="aarch64-linux-gdb"

echo "DictPen P5 Toolchain Ready!"
aarch64-linux-gcc --version | head -1
EOF
          chmod +x dictpen-env.sh

      - name: Upload SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: dictpen-p5-sdk
          path: |
            dictpen-p5-sdk.tar.gz
            dictpen-env.sh
          if-no-files-found: error