name: "Build Youdao DictPen: Build Youdao DictPen P5 Toolchain"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'
  push:
    branches: [main, master]
    paths:
      - '.github/workflows/build-dictpen-toolchain.yml'
      - 'configs/**'

permissions:
  contents: write
  packages: write

jobs:
  build-toolchain:
    runs-on: ubuntu-22.04
    
    timeout-minutes: 360
    
    env:
      BR_VERSION: "2018.02-rc3"
      BR_URL: "https://buildroot.org/downloads/buildroot-2018.02-rc3.tar.gz"
      TOOLCHAIN_NAME: "dictpen-p5-toolchain"
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            wget \
            cpio \
            unzip \
            rsync \
            bc \
            libncurses5-dev \
            libncursesw5-dev \
            libssl-dev \
            flex \
            bison \
            libelf-dev \
            python2 \
            python2-minimal \
            file \
            gawk \
            texinfo \
            help2man \
            libtool-bin \
            autoconf \
            automake \
            pkg-config \
            cmake \
            libglib2.0-dev \
            libfdt-dev \
            libpixman-1-dev \
            zlib1g-dev \
            device-tree-compiler \
            locales

          # 手动创建 python 软链接
          sudo ln -sf /usr/bin/python2 /usr/bin/python
          python --version

          sudo locale-gen en_US.UTF-8
          sudo update-locale LANG=en_US.UTF-8

      - name: Cache downloads
        uses: actions/cache@v3
        with:
          path: ~/buildroot/dl
          key: buildroot-dl-${{ env.BR_VERSION }}-${{ hashFiles('.github/workflows/build-dictpen-toolchain.yml') }}
          restore-keys: |
            buildroot-dl-${{ env.BR_VERSION }}-

      - name: Download Buildroot
        run: |
          mkdir -p ~/buildroot
          cd ~/buildroot
          
          if [ ! -f "buildroot-${BR_VERSION}.tar.gz" ]; then
            echo "Downloading Buildroot ${BR_VERSION}..."
            wget -q --show-progress "${BR_URL}"
          fi
          
          tar -xzf "buildroot-${BR_VERSION}.tar.gz"
          echo "Buildroot location: $(pwd)/buildroot-${BR_VERSION}"

      - name: Create and load config
        run: |
          cd ~/buildroot/buildroot-${BR_VERSION}
          
          # 清理
          make clean 2>/dev/null || true
          rm -rf output
          mkdir -p output
          touch output/.br-external.mk
          
          # 直接创建 .config 文件
          cat > .config << 'EOF'
          BR2_aarch64=y
          BR2_cortex_a55=y
          BR2_ARM_FPU_VFPV4=y
          BR2_TOOLCHAIN_BUILDROOT=y
          BR2_TOOLCHAIN_BUILDROOT_GLIBC=y
          BR2_GCC_VERSION_7_X=y
          BR2_BINUTILS_VERSION_2_29_X=y
          BR2_KERNEL_HEADERS_4_19=y
          BR2_TOOLCHAIN_BUILDROOT_CXX=y
          BR2_INSTALL_LIBSTDCPP=y
          BR2_TOOLCHAIN_HAS_SSP=y
          BR2_TOOLCHAIN_HAS_NATIVE_RPC=y
          BR2_USE_MMU=y
          BR2_TARGET_OPTIMIZATION="-pipe -O2"
          BR2_TARGET_GENERIC_GETTY=y
          BR2_TARGET_GENERIC_GETTY_PORT="ttyFIQ0"
          BR2_TARGET_GENERIC_HOSTNAME="buildroot"
          BR2_TARGET_GENERIC_ISSUE="Welcome to Buildroot"
          BR2_SYSTEM_BIN_SH_BUSYBOX=y
          BR2_SDK=y
          BR2_PACKAGE_HOST_GDB=y
          EOF
          
          # 使用 yes 命令自动回答所有提示，或直接使用 defconfig
          yes "" | make oldconfig 2>/dev/null || make defconfig
          
          echo "Configuration loaded:"
          head -50 .config

      - name: Build toolchain
        run: |
          cd ~/buildroot/buildroot-${BR_VERSION}
          
          echo "Starting toolchain build at $(date)"
          make toolchain -j$(nproc) 2>&1 | tee build.log
          echo "Finished at $(date)"
          
          ls -la output/host/usr/bin/ | head -20

      - name: Verify toolchain
        run: |
          cd ~/buildroot/buildroot-${BR_VERSION}
          export PATH="$(pwd)/output/host/usr/bin:$PATH"
          
          echo "=== GCC Version ==="
          aarch64-linux-gcc --version
          
          echo ""
          echo "=== Testing Compilation ==="
          cat > /tmp/test.c << 'EOF'
          #include <stdio.h>
          int main() {
              printf("Hello from GitHub Actions!\n");
              return 0;
          }
          EOF
          
          aarch64-linux-gcc -o /tmp/test-arm64 /tmp/test.c
          file /tmp/test-arm64

      - name: Create SDK package
        run: |
          cd ~/buildroot/buildroot-${BR_VERSION}
          
          echo "Creating SDK package..."
          make sdk-all 2>/dev/null || make sdk 2>/dev/null || echo "SDK target not available"
          
          # 打包工具链
          tar -czf ${TOOLCHAIN_NAME}-full.tar.gz \
            -C output/host/usr \
            bin/ \
            aarch64-buildroot-linux-gnu/
          
          ls -lh ${TOOLCHAIN_NAME}-full.tar.gz

      - name: Create environment script
        run: |
          cd ~/buildroot/buildroot-${BR_VERSION}
          
          cat > ${TOOLCHAIN_NAME}-setup-env.sh << 'EOF'
          #!/bin/bash
          TOOLCHAIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export PATH="$TOOLCHAIN_DIR/bin:$PATH"
          export CROSS_COMPILE="aarch64-linux-"
          export ARCH="arm64"
          export SYSROOT="$TOOLCHAIN_DIR/aarch64-buildroot-linux-gnu/sysroot"
          export CC="aarch64-linux-gcc --sysroot=$SYSROOT"
          export CXX="aarch64-linux-g++ --sysroot=$SYSROOT"
          echo "Toolchain activated: $(aarch64-linux-gcc --version | head -1)"
          EOF
          
          chmod +x ${TOOLCHAIN_NAME}-setup-env.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TOOLCHAIN_NAME }}
          path: |
            ~/buildroot/buildroot-*/${{ env.TOOLCHAIN_NAME }}-full.tar.gz
            ~/buildroot/buildroot-*/${{ env.TOOLCHAIN_NAME }}-setup-env.sh
          retention-days: 30
          compression-level: 0

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: ~/buildroot/buildroot-*/build.log
          retention-days: 7
