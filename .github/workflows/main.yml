name: Build DictPen P5 Toolchain

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-toolchain:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            wget \
            cpio \
            unzip \
            rsync \
            bc \
            libncurses5-dev \
            libncursesw5-dev \
            libssl-dev \
            flex \
            bison \
            libelf-dev \
            python2 \
            python3 \
            file \
            gawk \
            texinfo \
            help2man \
            libtool-bin \
            autoconf \
            automake \
            pkg-config \
            cmake \
            libglib2.0-dev \
            libfdt-dev \
            libpixman-1-dev \
            zlib1g-dev \
            device-tree-compiler \
            locales \
            curl \
            ca-certificates
          
          sudo ln -sf /usr/bin/python2 /usr/bin/python
          sudo locale-gen en_US.UTF-8
          sudo update-locale LANG=en_US.UTF-8

      - name: Set up environment
        run: |
          echo "LANG=en_US.UTF-8" >> $GITHUB_ENV
          echo "LC_ALL=en_US.UTF-8" >> $GITHUB_ENV

      - name: Cache Buildroot downloads
        id: cache-dl
        uses: actions/cache@v4
        with:
          path: ~/buildroot-work/buildroot-2018.02-rc3/dl
          key: ${{ runner.os }}-buildroot-dl-2018.02-rc3-${{ hashFiles('~/buildroot-work/buildroot-2018.02-rc3/configs/dictpen_p5_defconfig') }}
          restore-keys: |
            ${{ runner.os }}-buildroot-dl-2018.02-rc3-
            ${{ runner.os }}-buildroot-dl-

      - name: Cache Buildroot host tools
        id: cache-host
        uses: actions/cache@v4
        with:
          path: ~/buildroot-work/buildroot-2018.02-rc3/output/host
          key: ${{ runner.os }}-buildroot-host-2018.02-rc3-${{ hashFiles('~/buildroot-work/buildroot-2018.02-rc3/configs/dictpen_p5_defconfig') }}
          restore-keys: |
            ${{ runner.os }}-buildroot-host-2018.02-rc3-
            ${{ runner.os }}-buildroot-host-

      - name: Download Buildroot 2018.02-rc3
        run: |
          mkdir -p ~/buildroot-work
          cd ~/buildroot-work
          if [ ! -f buildroot-2018.02-rc3.tar.gz ]; then
            wget -q https://buildroot.org/downloads/buildroot-2018.02-rc3.tar.gz
          fi
          if [ ! -d buildroot-2018.02-rc3 ]; then
            tar -xzf buildroot-2018.02-rc3.tar.gz
          fi

      - name: Create defconfig file
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          mkdir -p configs
          
          cat > configs/dictpen_p5_defconfig << 'EOF'
          BR2_aarch64=y
          BR2_cortex_a55=y
          BR2_ARM_FPU_VFPV4=y
          BR2_TOOLCHAIN_BUILDROOT=y
          BR2_TOOLCHAIN_BUILDROOT_GLIBC=y
          BR2_GCC_VERSION_7_X=y
          BR2_BINUTILS_VERSION_2_29_X=y
          BR2_KERNEL_HEADERS_4_19=y
          BR2_TOOLCHAIN_BUILDROOT_CXX=y
          BR2_INSTALL_LIBSTDCPP=y
          BR2_TOOLCHAIN_HAS_SSP=y
          BR2_TOOLCHAIN_HAS_NATIVE_RPC=y
          BR2_USE_MMU=y
          BR2_TARGET_OPTIMIZATION="-pipe -O2"
          BR2_TARGET_GENERIC_GETTY=y
          BR2_TARGET_GENERIC_GETTY_PORT="ttyFIQ0"
          BR2_TARGET_GENERIC_HOSTNAME="buildroot"
          BR2_TARGET_GENERIC_ISSUE="Welcome to Buildroot"
          BR2_SYSTEM_BIN_SH_BUSYBOX=y
          BR2_SDK=y
          BR2_PACKAGE_HOST_GDB=y
          BR2_PACKAGE_HOST_DOSFSTOOLS=y
          BR2_PACKAGE_HOST_GENEXT2FS=y
          BR2_PACKAGE_HOST_MTOOLS=y
          EOF

      - name: Clean any existing m4 patches and build
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          rm -rf package/m4/*.patch
          rm -rf output/build/host-m4-*
          rm -rf dl/m4-1.4.18.tar.xz

      - name: Create m4 patch for Ubuntu 22.04
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          mkdir -p package/m4
          
          # 使用简单的 cat 命令创建补丁，避免 heredoc 问题
          echo "--- a/lib/c-stack.c" > package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "+++ b/lib/c-stack.c" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "@@ -16,16 +16,17 @@" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "     along with this program.  If not, see <http://www.gnu.org/licenses/>.  */" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " " >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " /* Written by Paul Eggert.  */" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " " >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " #include <config.h>" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " " >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "-#include \"c-stack.h\"" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "-" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " #include <errno.h>" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " #include <signal.h>" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " #include <stdbool.h>" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " #include <stdlib.h>" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " #include <string.h>" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " #include <unistd.h>" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " " >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "+#include \"c-stack.h\"" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "+" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " #if HAVE_SETRLIMIT" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " /* FIXME: This use of HAVE_SETRLIMIT is wrong, as it checks for the" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "    function, not the symbol.  But glibc defines setrlimit unconditionally," >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "@@ -49,15 +50,7 @@" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " #endif" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " #endif" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " " >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "-#if HAVE_LIBSIGSEGV" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "-# include <sigsegv.h>" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "-#elif defined HAVE_LIBSIGSEGV && SIGSTKSZ < 16384" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "-/* libsigsegv 2.6 through 2.8 have a bug where sigsegv_handler fails" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "-   to install the preallocated stack for the overflow handler.  */" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "-# else" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "-# define LIBSIGSEGV_PREALLOC_STACK 1" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "-# include <sigsegv.h>" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "-#endif" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo "+#include <sigsegv.h>" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " " >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " #if HAVE_SIGALTSTACK && HAVE_DECL_SIGALTSTACK && HAVE_STACK_T" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          echo " # include <ucontext.h>" >> package/m4/0001-fix-c-stack-ubuntu22.patch
          
          echo "补丁文件创建完成"
          cat package/m4/0001-fix-c-stack-ubuntu22.patch

      - name: Initialize Buildroot and Configure
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          
          mkdir -p output/build
          mkdir -p output/host
          mkdir -p output/staging
          mkdir -p output/target
          mkdir -p output/images
          
          touch output/.br-external.mk
          
          make defconfig
          make dictpen_p5_defconfig
          
          if [ -f .config ]; then
            echo "✅ Configuration successful"
            grep "^BR2_" .config | grep -v "^#" | head -20
          else
            echo "❌ Configuration failed"
            exit 1
          fi

      - name: Build toolchain
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          echo "Starting toolchain build (this will take 2-3 hours)..."
          make host-m4 -j2
          make toolchain -j2
        env:
          FORCE_UNSAFE_CONFIGURE: 1

      - name: Verify toolchain
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          
          if [ ! -d output/host/usr/bin ]; then
            echo "❌ Toolchain not found!"
            exit 1
          fi
          
          export PATH="$PWD/output/host/usr/bin:$PATH"
          
          echo "=== Toolchain version ==="
          aarch64-linux-gcc --version
          
          echo "=== Checking compiler target ==="
          aarch64-linux-gcc -dumpmachine
          
          cat > /tmp/test.c << 'EOF'
          #include <stdio.h>
          int main() {
              printf("Hello from DictPen P5!\n");
              return 0;
          }
          EOF
          
          aarch64-linux-gcc -o /tmp/test-arm64 /tmp/test.c
          file /tmp/test-arm64
          echo "✅ Toolchain verification passed!"

      - name: Create SDK package
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          make sdk || true
          
          if ls output/images/*sdk*.tar.gz 1> /dev/null 2>&1; then
            cp output/images/*sdk*.tar.gz .
          else
            tar -czf aarch64-buildroot-linux-gnu_sdk.tar.gz -C output/host .
          fi

      - name: Create environment script
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          
          cat > dictpen-env.sh << 'EOF'
          #!/bin/bash
          TOOLCHAIN_DIR="$( cd "$(dirname "${BASH_SOURCE[0]}")" && pwd )"
          
          export PATH="$TOOLCHAIN_DIR/output/host/usr/bin:$PATH"
          export CROSS_COMPILE="aarch64-linux-"
          export ARCH="arm64"
          
          if [ -d "$TOOLCHAIN_DIR/output/host/usr/aarch64-buildroot-linux-gnu/sysroot" ]; then
              export SYSROOT="$TOOLCHAIN_DIR/output/host/usr/aarch64-buildroot-linux-gnu/sysroot"
          else
              export SYSROOT="$TOOLCHAIN_DIR/output/host/usr/aarch64-buildroot-linux-gnu"
          fi
          
          export CC="aarch64-linux-gcc --sysroot=$SYSROOT"
          export CXX="aarch64-linux-g++ --sysroot=$SYSROOT"
          
          echo "========================================="
          echo "DictPen P5 Toolchain Ready!"
          echo "GCC: $(aarch64-linux-gcc --version | head -1)"
          echo "Example: \$CC -o hello hello.c"
          echo "========================================="
          EOF
          
          chmod +x dictpen-env.sh

      - name: Package toolchain
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          tar -czf dictpen-p5-toolchain-complete.tar.gz \
              output/host \
              dictpen-env.sh \
              configs/dictpen_p5_defconfig \
              .config
          
          echo "✅ Toolchain packaged: dictpen-p5-toolchain-complete.tar.gz"
          ls -lh *.tar.gz

      - name: Upload toolchain artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dictpen-p5-toolchain
          path: |
            ~/buildroot-work/buildroot-2018.02-rc3/dictpen-p5-toolchain-complete.tar.gz
            ~/buildroot-work/buildroot-2018.02-rc3/*sdk*.tar.gz
            ~/buildroot-work/buildroot-2018.02-rc3/dictpen-env.sh
          retention-days: 30
          if-no-files-found: warn

      - name: Upload build logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            ~/buildroot-work/buildroot-2018.02-rc3/output/build/**/*.log
            ~/buildroot-work/buildroot-2018.02-rc3/config.log
          retention-days: 7