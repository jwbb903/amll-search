name: Build DictPen P5 Toolchain

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-toolchain:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            wget \
            cpio \
            unzip \
            rsync \
            bc \
            libncurses5-dev \
            libncursesw5-dev \
            libssl-dev \
            flex \
            bison \
            libelf-dev \
            python2 \
            python3 \
            file \
            gawk \
            texinfo \
            help2man \
            libtool-bin \
            autoconf \
            automake \
            pkg-config \
            cmake \
            libglib2.0-dev \
            libfdt-dev \
            libpixman-1-dev \
            zlib1g-dev \
            device-tree-compiler \
            locales \
            curl \
            ca-certificates
          
          # 创建 python 指向 python2 的符号链接
          sudo ln -sf /usr/bin/python2 /usr/bin/python
          
          # 设置 locale
          sudo locale-gen en_US.UTF-8
          sudo update-locale LANG=en_US.UTF-8

      - name: Set up environment
        run: |
          echo "LANG=en_US.UTF-8" >> $GITHUB_ENV
          echo "LC_ALL=en_US.UTF-8" >> $GITHUB_ENV

      - name: Cache Buildroot downloads
        id: cache-dl
        uses: actions/cache@v4
        with:
          path: ~/buildroot-work/buildroot-2018.02-rc3/dl
          key: ${{ runner.os }}-buildroot-dl-2018.02-rc3-${{ hashFiles('~/buildroot-work/buildroot-2018.02-rc3/configs/dictpen_p5_defconfig') }}
          restore-keys: |
            ${{ runner.os }}-buildroot-dl-2018.02-rc3-
            ${{ runner.os }}-buildroot-dl-

      - name: Cache Buildroot host tools
        id: cache-host
        uses: actions/cache@v4
        with:
          path: ~/buildroot-work/buildroot-2018.02-rc3/output/host
          key: ${{ runner.os }}-buildroot-host-2018.02-rc3-${{ hashFiles('~/buildroot-work/buildroot-2018.02-rc3/configs/dictpen_p5_defconfig') }}
          restore-keys: |
            ${{ runner.os }}-buildroot-host-2018.02-rc3-
            ${{ runner.os }}-buildroot-host-

      - name: Cache Buildroot build artifacts
        id: cache-build
        uses: actions/cache@v4
        with:
          path: |
            ~/buildroot-work/buildroot-2018.02-rc3/output/build
            ~/buildroot-work/buildroot-2018.02-rc3/output/staging
            ~/buildroot-work/buildroot-2018.02-rc3/output/target
          key: ${{ runner.os }}-buildroot-build-2018.02-rc3-${{ hashFiles('~/buildroot-work/buildroot-2018.02-rc3/configs/dictpen_p5_defconfig') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-buildroot-build-2018.02-rc3-
            ${{ runner.os }}-buildroot-build-

      - name: Download Buildroot 2018.02-rc3
        run: |
          mkdir -p ~/buildroot-work
          cd ~/buildroot-work
          if [ ! -f buildroot-2018.02-rc3.tar.gz ]; then
            wget -q https://buildroot.org/downloads/buildroot-2018.02-rc3.tar.gz
          fi
          if [ ! -d buildroot-2018.02-rc3 ]; then
            tar -xzf buildroot-2018.02-rc3.tar.gz
          fi

      - name: Create defconfig
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          mkdir -p configs
          cat > configs/dictpen_p5_defconfig << 'EOF'
          # Buildroot 2018.02-rc3 for Youdao DictPen P5 (RK3566)
          
          # Target Architecture
          BR2_aarch64=y
          BR2_cortex_a55=y
          BR2_ARM_FPU_VFPV4=y
          
          # Toolchain
          BR2_TOOLCHAIN_BUILDROOT=y
          BR2_TOOLCHAIN_BUILDROOT_GLIBC=y
          BR2_GCC_VERSION_7_X=y
          BR2_BINUTILS_VERSION_2_29_X=y
          BR2_KERNEL_HEADERS_4_19=y
          BR2_TOOLCHAIN_BUILDROOT_CXX=y
          BR2_INSTALL_LIBSTDCPP=y
          BR2_TOOLCHAIN_HAS_SSP=y
          BR2_TOOLCHAIN_HAS_NATIVE_RPC=y
          
          # System
          BR2_USE_MMU=y
          BR2_TARGET_OPTIMIZATION="-pipe -O2"
          BR2_TARGET_GENERIC_GETTY=y
          BR2_TARGET_GENERIC_GETTY_PORT="ttyFIQ0"
          BR2_TARGET_GENERIC_HOSTNAME="buildroot"
          BR2_TARGET_GENERIC_ISSUE="Welcome to Buildroot"
          BR2_SYSTEM_BIN_SH_BUSYBOX=y
          
          # SDK and tools
          BR2_SDK=y
          BR2_PACKAGE_HOST_GDB=y
          
          # Additional useful tools
          BR2_PACKAGE_HOST_DOSFSTOOLS=y
          BR2_PACKAGE_HOST_GENEXT2FS=y
          BR2_PACKAGE_HOST_MTOOLS=y
          EOF

      - name: Configure Buildroot
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          make dictpen_p5_defconfig

      - name: Build toolchain
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          # 使用 -j2 限制并行度，避免 GitHub Actions 资源不足
          # 如果缓存命中，可能只需要增量编译
          make toolchain -j2
        env:
          FORCE_UNSAFE_CONFIGURE: 1  # 允许以 root 身份运行（GitHub Actions 容器）

      - name: Verify toolchain
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          export PATH="$PWD/output/host/usr/bin:$PATH"
          echo "=== Toolchain version ==="
          aarch64-linux-gcc --version
          
          echo "=== GCC default target ==="
          aarch64-linux-gcc -v 2>&1 | grep "Target:"
          
          echo "=== GCC configure options ==="
          aarch64-linux-gcc -v 2>&1 | grep "Configured with:" | head -1
          
          # 创建测试程序
          cat > /tmp/test.c << 'EOF'
          #include <stdio.h>
          int main() {
              printf("Hello, DictPen P5!\n");
              return 0;
          }
          EOF
          
          echo "=== Compiling test program ==="
          aarch64-linux-gcc -o /tmp/test-arm64 /tmp/test.c
          file /tmp/test-arm64
          
          echo "=== Checking for Cortex-A55 optimization ==="
          aarch64-linux-gcc -Q --help=target | grep mcpu | grep a55 || echo "Note: mcpu=cortex-a55 may not be directly supported, using march=armv8-a instead"
          
          echo "✅ Toolchain verification passed!"

      - name: Create SDK package
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          make sdk
          
          # 查找生成的 SDK 包
          SDK_PACKAGE=$(ls -t output/images/*sdk*.tar.gz 2>/dev/null | head -1)
          if [ -f "$SDK_PACKAGE" ]; then
            echo "SDK_PACKAGE=$SDK_PACKAGE" >> $GITHUB_ENV
            echo "SDK package created: $SDK_PACKAGE"
          else
            echo "Warning: SDK package not found, creating archive manually"
            tar -czf output/images/aarch64-buildroot-linux-gnu_sdk-buildroot.tar.gz -C output/host .
            echo "SDK_PACKAGE=output/images/aarch64-buildroot-linux-gnu_sdk-buildroot.tar.gz" >> $GITHUB_ENV
          fi

      - name: Create environment script
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          cat > output/dictpen-env.sh << 'EOF'
          #!/bin/bash
          # DictPen P5 Toolchain environment script
          
          SCRIPTPATH="$( cd "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"
          export PATH="$SCRIPTPATH/host/usr/bin:$PATH"
          export CROSS_COMPILE="aarch64-linux-"
          export ARCH="arm64"
          export SYSROOT="$SCRIPTPATH/host/usr/aarch64-buildroot-linux-gnu/sysroot"
          
          export CC="aarch64-linux-gcc --sysroot=\$SYSROOT"
          export CXX="aarch64-linux-g++ --sysroot=\$SYSROOT"
          export LD="aarch64-linux-ld --sysroot=\$SYSROOT"
          export AR="aarch64-linux-ar"
          export AS="aarch64-linux-as"
          export NM="aarch64-linux-nm"
          export STRIP="aarch64-linux-strip"
          export RANLIB="aarch64-linux-ranlib"
          export OBJCOPY="aarch64-linux-objcopy"
          export OBJDUMP="aarch64-linux-objdump"
          export GDB="aarch64-linux-gdb"
          
          echo "========================================="
          echo "DictPen P5 Toolchain Ready!"
          echo "========================================="
          aarch64-linux-gcc --version | head -1
          echo "CROSS_COMPILE: $CROSS_COMPILE"
          echo "SYSROOT: $SYSROOT"
          echo ""
          echo "Example:"
          echo "  \$CC -o hello hello.c"
          echo "========================================="
          EOF
          
          chmod +x output/dictpen-env.sh
          
          # 打包完整的 toolchain
          cd output
          tar -czf ../dictpen-p5-toolchain-complete.tar.gz host/ dictpen-env.sh
          cd ..

      - name: Create installation instructions
        run: |
          cd ~/buildroot-work/buildroot-2018.02-rc3
          cat > README-toolchain.md << 'EOF'
          # DictPen P5 Toolchain

          ## 安装说明

          1. 解压工具链：
             ```bash
             tar -xzf dictpen-p5-toolchain-complete.tar.gz -C /opt/
             ```

          2. 设置环境变量：
             ```bash
             source /opt/dictpen-p5-toolchain/dictpen-env.sh
             ```
             或者永久添加到 ~/.bashrc：
             ```bash
             echo "source /opt/dictpen-p5-toolchain/dictpen-env.sh" >> ~/.bashrc
             ```

          3. 编译测试程序：
             ```bash
             $CC -o hello hello.c
             file hello  # 应该显示 ARM aarch64
             ```

          ## 工具链信息

          - 架构：ARM64 (aarch64)
          - 优化：Cortex-A55
          - C库：glibc
          - GCC版本：7.5.0
          - 内核头文件：4.19

          ## 目录结构

          - `host/` - 完整的工具链
          - `dictpen-env.sh` - 环境设置脚本
          EOF

      - name: Upload toolchain artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dictpen-p5-toolchain
          path: |
            ~/buildroot-work/buildroot-2018.02-rc3/dictpen-p5-toolchain-complete.tar.gz
            ~/buildroot-work/buildroot-2018.02-rc3/output/images/*sdk*.tar.gz
            ~/buildroot-work/buildroot-2018.02-rc3/README-toolchain.md
          retention-days: 30
          if-no-files-found: warn

      - name: Upload build logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            ~/buildroot-work/buildroot-2018.02-rc3/output/build/**/*.log
            ~/buildroot-work/buildroot-2018.02-rc3/output/build/**/config.log
            ~/buildroot-work/buildroot-2018.02-rc3/output/build/**/build.log
          retention-days: 7

      - name: Display build summary
        if: success()
        run: |
          echo "## ✅ 工具链构建成功！" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 构建信息" >> $GITHUB_STEP_SUMMARY
          echo "- **提交**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **分支**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **运行ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 下载" >> $GITHUB_STEP_SUMMARY
          echo "在 Actions 页面下载以下工件：" >> $GITHUB_STEP_SUMMARY
          echo "- `dictpen-p5-toolchain` - 完整工具链" >> $GITHUB_STEP_SUMMARY